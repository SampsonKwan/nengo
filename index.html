<!DOCTYPE html>
<html lang="en">
<head>
<title>Nengo Editor</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 50%;
    }
    
    .highlight {
        background: yellow;
        opacity: 0.2;
        position: absolute;
        }
    div#graph { 
        position: absolute;
        top: 0;
        right: 50%;
        bottom: 0;
        left: 0;
        background-color: white;
    }
    
    svg .link {
        stroke: #333;
        stroke-opacity: .6;
        stroke-width: 2px;
        marker-mid: url(#TriangleMarker);
    }
    
    svg .node {
        stroke: #444;
        stroke-width: 0px;
        
    }
    
    svg g.gnode text {
        fill: black;
        font-family: sans-serif;
        text-anchor: middle;
        alignment-baseline: middle;
        }
    
    
</style>
</head>
<body>

<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
var aceRange = ace.require('ace/range').Range;
</script>
<script src="d3.min.js", type="text/javascript" charset="utf-8"></script>

<div id="editor">import nengo

model = nengo.Model()
with model:
    a = nengo.Ensemble(neurons=100, dimensions=2, label='a')
    b = nengo.Ensemble(neurons=80, dimensions=2)
    c = nengo.Ensemble(neurons=80, dimensions=2)
    d = nengo.Ensemble(neurons=80, dimensions=2)
    nengo.Connection(a, b, filter=0.01)
    nengo.Connection(b, c, filter=0.01)
    nengo.Connection(c, d, filter=0.01)
    nengo.Connection(b, d, filter=0.01)
</div>
    
<div id="graph">
    <svg>
        <defs>
            // the arrow on the links
            <marker id="TriangleMarker"
              viewBox="0 0 10 10" refX="0" refY="5" 
              markerUnits="strokeWidth"
              markerWidth="6" markerHeight="4"
              orient="auto">
              <path d="M 0 0 L 10 5 L 0 10 z" />
            </marker>    
        </defs>    
    </svg>
</div>    

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/python");
    
    editor.on('change', editorChange);
    
    var svg = d3.select("svg");
    
    var force = d3.layout.force()
        .charge(-120)
        .linkDistance(100)
        .size([100, 100]);
    
    var drag = force.drag()
        .on('dragstart', dragstart);
        
    function editorChange(e) {
        var data = new FormData();
        data.append('code', editor.getValue());

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/graph.json', true);
        xhr.onload = update_graph;
        xhr.send(data);    
    }    
        
        
    function dragstart(d) {
      d3.select(this).classed("fixed", d.fixed = true);
    }    

    function dblclick(d) {
      d3.select(this).classed("fixed", d.fixed = false);
    }    
    
    var marker = null;
    function mouseover(d) {
        if (marker!=null) {
            editor.getSession().removeMarker(marker);
            marker = null;
            }
        marker = editor.getSession().addMarker(new aceRange(d.line, 0, d.line, 10), 'highlight', 'fullLine', true);
        editor.getSession().setAnnotations([{row: d.line, type:'info'}]);
        }
    function mouseout(d) {
        if (marker!=null) {
            editor.getSession().removeMarker(marker);
            marker = null;
            }
        editor.getSession().clearAnnotations();
        }
        
        
    var data = new FormData();
    data.append('code', editor.getValue());

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/graph.json', true);
    xhr.onload = update_graph;
    xhr.send(data);

    
        
    function update_graph() {
        graph = JSON.parse(this.responseText);
        
        if (graph.error_line != undefined) {
            if (marker!=null) {
                editor.getSession().removeMarker(marker);
                marker = null;
                }
            marker = editor.getSession().addMarker(new aceRange(graph.error_line-1, 0, graph.error_line-1, 10), 'highlight', 'fullLine', true);
            editor.getSession().setAnnotations([{row: graph.error_line-1, type:'error'}]);
            return;
        } else {
            if (marker!=null) {
                editor.getSession().removeMarker(marker);
                marker = null;
                }
            editor.getSession().clearAnnotations();
        }

        

        function tick() {        
            link.attr("points", function (d) {
                 return ""+d.source.x+","+d.source.y+" "+
                           (d.source.x*0.45+d.target.x*0.55)+","+
                           (d.source.y*0.45+d.target.y*0.55)+" "+
                           d.target.x+","+d.target.y});
                
                
            gnodes.attr('transform', function(d) {
                return 'translate('+[d.x, d.y]+')';
                });
            
            node.attr("fill", function(d) { if (d.fixed) {return '#ccc';} else {return '#ddd';}})
        }                
        
        function resize() {
            width = window.innerWidth/2;
            height = window.innerHeight;
            svg.attr("width", width).attr("height", height);
            force.size([width, height]).resume();            
        }    
            
        resize();
        d3.select(window).on("resize", resize);
        
        force.nodes(graph.nodes)
             .links(graph.links)
             .on('tick', tick)
             .start();
        
        var link = svg.selectAll('.link')
            .data(graph.links)
            .enter().append('polyline')
                .attr('class', 'link')
                
        svg.selectAll('.link')
            .data(graph.links)        
            .exit().remove();    
                

                
        var gnodes = svg.selectAll('g.gnode')
            .data(graph.nodes)
            .enter()
            .append('g')
            .classed('gnode', true)
            .on("dblclick", dblclick)
            .on('mouseover', mouseover)
            .on('mouseout', mouseout)
            .call(force.drag);
        
            
        var node = gnodes.append('circle')
                .attr('class', 'node')
                .attr('r', '20')
                
                
        var labels = gnodes.append('text')
            .text(function(d) {return d.label;});
                


                
    }  

        
</script>
</body>
</html>